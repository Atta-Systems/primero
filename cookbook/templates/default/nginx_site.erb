server {
  listen <%= @http_port %>;
  <%= "server_name #{@server_name};" if @server_name %>
  rewrite ^(.*)$ https://$host:<%= @https_port %>$1 redirect;
}

server {
  listen <%= @https_port %> ssl;
  <%= "server_name #{@server_name};" if @server_name %>
  ssl_certificate <%= @ssl_cert_path %>;
  ssl_certificate_key <%= @ssl_key_path %>;

  passenger_enabled on;
  passenger_min_instances <%= @passenger_conf['min_instances'] || 1 %>;
  passenger_ruby <%= @rvm_ruby_path %>;
  passenger_sticky_sessions on;

  rails_env <%= @rails_env %>;

  passenger_set_cgi_param RAILS_LOG_PATH "<%= @rails_log_dir %>";

  gzip_disable "MSIE [1-6]\.";
  root <%= @current_path %>/public;
  access_log <%= @log_dir %>/nginx_server.log;
  error_log <%= @log_dir %>/nginx_error.log error;
  client_max_body_size 50M;

  location ~* ^/(assets|images|javascripts|stylesheets)/ {
    gzip_static on;
    add_header Cache-Control max-age=31536000;
  }
}

<%= "passenger_pre_start https://#{@server_name}:#{@https_port}/;" if @server_name %>
